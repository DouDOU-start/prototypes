# 上下文优化和Token管理

## 📦 /compact 命令使用规范

### 命令功能
`/compact` 命令用于压缩对话上下文，优化token使用，在保持关键信息的同时减少对话长度。

### 🚀 强制使用场景

#### 1. 🔄 必须使用 /compact 的情况

##### 对话长度过长
- **触发条件**：
  - 连续对话超过50轮交互
  - 上下文包含大量代码片段和详细说明
  - 感觉响应速度明显变慢
  - 收到关于上下文长度的系统提醒
- **使用时机**：在继续复杂任务前进行压缩
- **预期效果**：保留核心上下文，删除冗余信息

##### 切换工作重点
- **触发条件**：
  - 从一个项目切换到另一个项目
  - 完成某个功能模块，开始新的开发任务
  - 从调试模式转入新功能开发
  - 结束讨论性对话，开始实施性工作
- **使用策略**：`/compact 保留当前项目的核心信息和技术栈设置`
- **执行时机**：在开始新阶段工作前立即执行

##### Token使用优化
- **触发条件**：
  - 对话包含大量重复的代码示例
  - 多次引用相同的文档内容
  - 存在过多的调试输出和日志信息
  - 包含大量已解决问题的讨论历史
- **优化策略**：`/compact 重点保留未解决的问题和当前任务状态`
- **执行时机**：感到响应变慢或内容重复时

#### 2. 📝 /compact 使用最佳实践

##### 基本语法
```bash
# 基础压缩
/compact

# 带聚焦指令的压缩
/compact 保留当前开发任务和技术要求

# 项目切换时的压缩
/compact 保留项目架构信息，移除调试历史

# 阶段性压缩
/compact 保留核心功能需求，删除已完成任务的详细过程
```

##### 聚焦指令示例
```bash
# 开发阶段切换
/compact 保留代码结构和待实现功能，移除讨论过程

# 问题解决后
/compact 保留解决方案和最终代码，删除调试过程

# 项目重点转移
/compact 重点保留新功能需求和相关技术栈信息

# 文档整理时
/compact 保留核心规范和标准，简化示例说明
```

#### 3. 🎯 使用时机判断

##### 立即使用的信号
- **性能指标**：响应时间明显变长
- **内容重复**：相同信息在对话中多次出现
- **任务转换**：即将开始完全不同的工作内容
- **上下文混乱**：当前对话包含多个不相关的主题

##### 谨慎使用的情况
- **活跃调试中**：正在解决复杂问题时
- **代码审查中**：需要参考之前的代码版本时
- **学习过程中**：需要回顾之前的解释和示例时
- **多人协作中**：其他人可能需要参考对话历史时

#### 4. 🔧 与工作流程集成

##### 阶段性压缩策略
```
需求分析阶段完成 → /compact 保留最终需求和技术方案
↓
设计阶段完成 → /compact 保留设计决策和架构信息  
↓
开发阶段完成 → /compact 保留最终代码和核心功能
↓
测试阶段完成 → /compact 保留测试结果和待优化项
```

##### 与Git提交协调
```bash
# 重要功能完成后
git commit -m "新增: 用户认证模块完整实现"
/compact 保留认证模块相关信息，准备开始下个功能

# 问题修复后
git commit -m "修复: 购物车计算逻辑错误"
/compact 保留修复方案，删除调试过程
```

#### 5. 📊 效果监控和优化

##### 压缩效果评估
- **响应速度**：压缩后响应是否明显加快
- **信息完整性**：关键上下文是否得到保留
- **工作连续性**：是否影响后续任务的执行
- **理解准确性**：Claude是否仍能准确理解需求

##### 优化策略
- **渐进式压缩**：先进行轻度压缩，观察效果
- **分类保留**：明确指定需要保留的信息类型
- **定期检查**：压缩后验证关键信息是否完整
- **备份重要内容**：将关键代码和决策记录到文档中

## 🎯 自动化建议

### 触发提醒机制
建议在以下情况自动考虑使用 `/compact`：
- 对话轮次超过阈值时
- 切换项目或主要任务时
- 完成重要里程碑后
- 感到上下文混乱时

### 与其他工具协调
- **TodoWrite**: 压缩前确保重要任务已记录
- **Git提交**: 重要变更提交后进行上下文压缩
- **文档更新**: 关键信息记录到文档后可安全压缩

## 📈 使用效果目标

通过合理使用 `/compact` 命令：
- **Token效率提升 40%**：减少不必要的上下文开销
- **响应速度提升 30%**：优化对话处理效率  
- **焦点集中度提升**：去除干扰信息，专注当前任务
- **工作流程优化**：清晰的阶段划分和任务转换

## ⚠️ 注意事项

### 使用前确认
- 确保重要信息已妥善保存
- 验证当前任务状态清晰
- 考虑是否需要保留特定的上下文信息

### 使用后验证
- 检查关键信息是否保留
- 确认工作连续性未受影响
- 验证后续交互的准确性